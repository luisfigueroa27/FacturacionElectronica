@model ApiSunat.Domain.Entities.Documento
@{
    bool esFactura = Model.TipoDocumento == "Factura";
    ViewData["Title"] = (esFactura ? "Emitir Factura" : "Emitir Boleta de Venta");
}

<div class="d-flex align-items-center mb-3">
    <a asp-action="Index" asp-route-empresaId="@Model.EmpresaId" class="btn btn-link nav-link p-0 me-3">
        <i class="fas fa-arrow-left"></i> Volver
    </a>
    <h2 class="mb-0">
        Emitir @(esFactura ? "Factura" : "Boleta de Venta")
    </h2>
</div>

<form asp-action="CrearDocumento" method="post" id="formEmision">

    <input type="hidden" asp-for="EmpresaId" />
    <input type="hidden" asp-for="TipoDocumento" />

    <div class="card shadow-sm">
        <div class="card-body p-4">

            <div class="row mb-4">

                <div class="col-md-7">
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <img src="@(Model.Empresa.LogoUrl ?? "/images/default-logo.png")"
                                 alt="Logo" style="width: 60px; height: 60px; border-radius: 8px; object-fit: cover;" />
                        </div>
                        <div class="flex-grow-1">
                            <h5 class="mb-0">@Model.Empresa.NombreComercial</h5>
                            <p class="mb-1 text-muted">@Model.Empresa.NombreLegal</p>
                            <small class="text-muted">@Model.Empresa.DireccionFiscal</small>
                        </div>
                    </div>
                </div>

                <div class="col-md-5">
                    <div class="border rounded p-3 text-center">
                        <h5>R.U.C. N° @Model.Empresa.Ruc</h5>
                        <h4 class="mb-0">
                            @(esFactura ? "FACTURA ELECTRÓNICA" : "BOLETA DE VENTA ELECTRÓNICA")
                        </h4>
                        <div class="d-flex justify-content-center mt-2">
                            <input asp-for="Serie" class="form-control text-end" style="width: 80px;" readonly />
                            <span class="fs-4 mx-2">-</span>
                            <input asp-for="Correlativo" class="form-control" style="width: 120px;" readonly />
                        </div>
                    </div>
                </div>
            </div>

            <hr />

            <h5 class="mb-3">Cliente</h5>
            <div class="row g-3">
                <div class="col-md-3">
                    <select class="form-select" id="tipoDocCliente" name="TipoDocumentoCliente">
                        <option value="RUC" selected="@esFactura">RUC</option>
                        <option value="DNI" selected="@(!esFactura)">DNI</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <div class="input-group">
                        <input type="text" id="numDocCliente" class="form-control" placeholder="Número de documento" name="NumeroDocumentoCliente" />
                        <button class="btn btn-outline-secondary" type="button" id="btnBuscarCliente">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
                <div class="col-md-5">
                    <input type="text" id="nombreCliente" class="form-control" placeholder="Nombre o Razón Social" name="NombreCliente" />
                </div>
                <div class="col-12">
                    <input type="text" id="dirCliente" class="form-control" placeholder="Dirección (opcional)" name="DireccionCliente" />
                </div>
            </div>

            <hr />

            <div class="row g-3 mb-3">
                <div class="col-md-3">
                    <label class="form-label">F. de Emisión</label>
                    <input asp-for="FechaEmision" class="form-control" type="date" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">Vencimiento</label>
                    <input asp-for="FechaVencimiento" class="form-control" type="date" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">Moneda</label>
                    <select asp-for="Moneda" class="form-select">
                        <option value="PEN">PEN - (S/) Sol</option>
                        <option value="USD">USD - ($) Dólar Americano</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Forma de Pago</label>
                    <select asp-for="FormaPago" class="form-select">
                        <option value="Contado">Contado</option>
                        <option value="Credito">Crédito</option>
                    </select>
                </div>
            </div>

            <div class="border rounded p-3">
                <div class="text-end mb-3">
                    <button type="button" class="btn btn-primary" id="btnAgregarItem">
                        <i class="fas fa-plus"></i> Agregar un ítem
                    </button>
                </div>

                <table class="table" id="tablaItems">
                    <thead>
                        <tr>
                            <th>Cant.</th>
                            <th>Descripción</th>
                            <th class="text-end">V. Unitario</th>
                            <th class="text-end">Importe</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="5" class="text-center text-muted">No hay ítems agregados.</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="row mt-4">
                <div class="col-md-6">
                    <label class="form-label">Importe en Letras</label>
                    <input asp-for="ImporteEnLetras" class="form-control" readonly />

                    <label class="form-label mt-2">Observaciones</label>
                    <textarea asp-for="Observaciones" class="form-control" rows="2"></textarea>
                </div>
                <div class="col-md-6">
                    <div class="mb-3 row">
                        <label class="col-sm-6 col-form-label text-end">Ope. Gravada:</label>
                        <div class="col-sm-6">
                            <input asp-for="TotalOperacionGravada" class="form-control text-end" readonly />
                        </div>
                    </div>
                    <div class="mb-3 row">
                        <label class="col-sm-6 col-form-label text-end">IGV (18%):</label>
                        <div class="col-sm-6">
                            <input asp-for="TotalIGV" class="form-control text-end" readonly />
                        </div>
                    </div>
                    <div class="mb-3 row">
                        <label class="col-sm-6 col-form-label text-end fw-bold">Importe Total:</label>
                        <div class="col-sm-6">
                            <input asp-for="ImporteTotal" class="form-control text-end fw-bold" readonly />
                        </div>
                    </div>
                </div>
            </div>

            <div class="text-end mt-4">
                <button type="submit" class="btn btn-success btn-lg">
                    Emitir @(esFactura ? "Factura" : "Boleta")
                </button>
            </div>

        </div>
    </div>
</form>

<div class="modal fade" id="itemModal" tabindex="-1" aria-labelledby="itemModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title" id="itemModalLabel">Agregar Ítem</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body" id="itemModalBody">
            </div>

        </div>
    </div>
</div>


@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        $(document).ready(function () {

            const empresaId = @Model.EmpresaId;
            const igvRate = 1.18; // 18%

            // --- Variables del Modal ---
            // CAMBIO 1: No inicializamos el modal aquí. Solo guardamos el elemento.
            const itemModalElement = document.getElementById('itemModal');
            const itemModalBody = $('#itemModalBody');

            // --- Variables de la Tabla y Totales ---
            const tablaBody = $('#tablaItems tbody');
            const formTotales = {
                opGravada: $('#TotalOperacionGravada'),
                igv: $('#TotalIGV'),
                importeTotal: $('#ImporteTotal'),
                enLetras: $('#ImporteEnLetras')
            };

            let itemIndex = 0;


            // 1. ABRIR EL MODAL DE AGREGAR ÍTEM
            $('#btnAgregarItem').on('click', function () {
                const url = `/Emision/_AgregarItemModal?empresaId=${empresaId}`;
                itemModalBody.load(url, function () {
                    // Obtenemos la instancia de Bootstrap y la mostramos
                    const modal = bootstrap.Modal.getOrCreateInstance(itemModalElement);
                    modal.show();
                });
            });


            // 2. CONFIRMAR AGREGAR ÍTEM (Escucha el clic DENTRO del modal)
            $(document).on('click', '#btnConfirmarAgregarItem', function () {
                const data = {
                    cantidad: parseFloat($('#itemCantidad').val()),
                    descripcion: $('#itemDescripcion').val(),
                    valorUnitario: parseFloat($('#itemValorUnitario').val()),
                    importeTotal: parseFloat($('#itemImporte').val())
                };

                if (data.cantidad <= 0 || data.importeTotal <= 0 || !data.descripcion) {
                    alert("Verifique la cantidad, descripción y montos.");
                    return;
                }

                if (tablaBody.find('.no-items').length > 0) {
                    tablaBody.empty();
                }

                // (Mejora: agregamos 'html-entities' para evitar errores si la descripción tiene comillas)
                const safeDescripcion = $('<div/>').text(data.descripcion).html();

                const nuevaFila = `
                    <tr>
                        <td>
                            <input type="hidden" name="Detalles[${itemIndex}].Cantidad" value="${data.cantidad}" />
                            ${data.cantidad}
                        </td>
                        <td>
                            <input type="hidden" name="Detalles[${itemIndex}].Descripcion" value="${safeDescripcion}" />
                            <input type="hidden" name="Detalles[${itemIndex}].ValorUnitario" value="${data.valorUnitario}" />
                            ${safeDescripcion}
                        </td>
                        <td class="text-end">${data.valorUnitario.toFixed(5)}</td>
                        <td class="text-end" data-importe="${data.importeTotal}">${data.importeTotal.toFixed(2)}</td>
                        <td class="text-center">
                            <button type="button" class="btn btn-sm btn-outline-danger btnEliminarItem"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;

                tablaBody.append(nuevaFila);
                itemIndex++;
                recalculateTotals();

                // CAMBIO 2: Ocultamos el modal de esta forma robusta
                const modal = bootstrap.Modal.getInstance(itemModalElement);
                if (modal) {
                    modal.hide();
                }
            });


            // 3. ELIMINAR UN ÍTEM DE LA TABLA
            tablaBody.on('click', '.btnEliminarItem', function () {
                $(this).closest('tr').remove();
                if (tablaBody.children().length === 0) {
                     tablaBody.html('<tr><td colspan="5" class="text-center text-muted no-items">No hay ítems agregados.</td></tr>');
                }
                recalculateTotals();
            });


            // 4. RECALCULAR TOTALES (La función principal)
            function recalculateTotals() {
                let totalGeneral = 0;
                tablaBody.find('td[data-importe]').each(function () {
                    totalGeneral += parseFloat($(this).data('importe'));
                });

                let opGravada = totalGeneral / igvRate;
                let igv = totalGeneral - opGravada;

                formTotales.importeTotal.val(totalGeneral.toFixed(2));
                formTotales.opGravada.val(opGravada.toFixed(2));
                formTotales.igv.val(igv.toFixed(2));

                // (Opcional: Convertir a letras en tiempo real)
                if (totalGeneral > 0) {
                    // CAMBIO 3: Usamos un 'try-catch' por si la llamada fetch falla
                    try {
                        fetch(`/Emision/ConvertirALetras?monto=${totalGeneral}`)
                            .then(response => {
                                if (!response.ok) { // <-- Verificamos si la respuesta es 404 o 500
                                    throw new Error('Respuesta de red no fue OK');
                                }
                                return response.json();
                            })
                            .then(data => {
                                formTotales.enLetras.val(data.letras); // <-- Aquí se pone el texto
                            })
                            .catch(error => {
                                console.error("Error al convertir a letras:", error);
                                formTotales.enLetras.val("SON..."); // <-- Fallback
                            });
                    } catch (e) {
                         formTotales.enLetras.val("SON...");
                    }
                } else {
                    formTotales.enLetras.val("CERO CON 00/100 SOLES");
                }
            }
        });
    </script>
}
