@model ApiSunat.Domain.Entities.Empresa
@{
    ViewData["Title"] = "Lista de Precios";
    // Pasamos el ID de la empresa al JS para que sepa a quién agregar el ítem
    ViewData["EmpresaId"] = Model.EmpresaId;
}

<div class="d-flex align-items-center mb-3">
    <a asp-controller="Empresas" asp-action="Index" class="btn btn-link nav-link p-0 me-3">
        <i class="fas fa-arrow-left"></i> Volver
    </a>
    <h2 class="mb-0">Lista de Precios</h2>
</div>

<div class="card shadow-sm">
    <div class="card-body p-4">

        <div class="d-flex align-items-center mb-4">
            <div class="me-3">
                <img src="@(Model.LogoUrl ?? "/images/default-logo.png")" alt="Logo" style="width: 50px; height: 50px; border-radius: 8px; object-fit: cover;" />
            </div>
            <div class="flex-grow-1">
                <h5 class="mb-0">@Model.NombreComercial</h5>
                <small class="text-success">RUC: @Model.Ruc</small>
            </div>
        </div>

        <div class="d-flex justify-content-between mb-3">
            <div>
                <button class="btn btn-light">Importar</button>
                <button class="btn btn-light">Exportar</button>
            </div>
            <div>
                <button type="button" class="btn btn-primary" id="btnAgregarItem">
                    <i class="fas fa-plus me-1"></i> Agregar ítem
                </button>
            </div>
        </div>

        <table class="table table-hover">
            <thead>
                <tr>
                    <th>Unidad</th>
                    <th>Descripción</th>
                    <th class="text-end">Precio (inc. IGV)</th>
                    <th class="text-center">Acciones</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model.Productos)
                {
                    <tr>
                        <td>@item.UnidadMedida</td>
                        <td>
                            @if (!string.IsNullOrEmpty(item.Codigo))
                            {
                                <small class="text-muted d-block">[@item.Codigo]</small>
                            }
                            @item.Descripcion
                        </td>
                        <td class="text-end">
                            @((item.ValorUnitario * 1.18m).ToString("F2"))
                        </td>
                        <td class="text-center">
                            <button type="button" class="btn btn-sm btn-outline-secondary btnEditarItem"
                                    data-productoid="@item.ProductoId">
                                <i class="fas fa-pencil-alt"></i>
                            </button>

                            <form asp-action="Delete" method="post" class="d-inline"
                                  onsubmit="return confirm('¿Está seguro de eliminar este producto?');">
                                <input type="hidden" name="productoId" value="@item.ProductoId" />
                                <button type="submit" class="btn btn-sm btn-outline-danger">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </form>
                        </td>
                    </tr>
                }
            </tbody>
        </table>

    </div>
</div>


<div class="modal fade" id="productoModal" tabindex="-1" aria-labelledby="productoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title" id="productoModalLabel">...</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body" id="productoModalBody">
            </div>

        </div>
    </div>
</div>


@section Scripts {
    <script>
        $(document).ready(function () {

            var empresaId = @ViewData["EmpresaId"];
            var modal = new bootstrap.Modal(document.getElementById('productoModal'));
            var modalBody = $('#productoModalBody');
            var modalTitle = $('#productoModalLabel');

            // --- 1. Al hacer clic en "Agregar ítem" (Imagen 5) ---
            $('#btnAgregarItem').on('click', function () {

                var url = `/Productos/_ProductoModal?empresaId=${empresaId}`;

                modalTitle.text('Agregar Nuevo Ítem');
                modalBody.load(url, function () {
                    modal.show();
                    // Volvemos a registrar el validador de jQuery para el formulario cargado
                    $.validator.unobtrusive.parse('#productoForm');
                });
            });

            // --- 2. Al hacer clic en "Editar ítem" (Imagen 6) ---
            $('.btnEditarItem').on('click', function () {

                var productoId = $(this).data('productoid');
                var url = `/Productos/_ProductoModal?empresaId=${empresaId}&productoId=${productoId}`;

                modalTitle.text('Editar Ítem');
                modalBody.load(url, function () {
                    modal.show();
                    // Volvemos a registrar el validador
                    $.validator.unobtrusive.parse('#productoForm');
                });
            });

        });
    </script>
}
